/*!
 * part of the package to convert web2py elements to zurb foundation5 theme
 * Developed by Paolo Caruccio ( paolo.caruccio66@gmail.com )
 * Released under MIT license
 * version 1 rev.201403191600
 *
 * Supported version of zurb foundation framework: 5.0.3+

 * The full package includes:
 * - foundation5.py python module
 * - web2py-foundation5.css
 * - this js file
 * - example of layout.html

 */

(function ($) {

    // functions
    $.fn.center = function (options) {
        var defaults = {'parent': false, 'mode': "both"};
        var settings = $.extend(defaults, options);
        var parent;
        if (settings.parent) {
            parent = this.parent();
        } else {
            parent = window;
        }
        if (settings.mode != "horizontally") {
            this.css("top", Math.max(0, (($(parent).height() - $(this).outerHeight()) / 2) + $(parent).scrollTop()) + "px");}
        if (settings.mode != "vertically") {
            this.css("left", Math.max(0, (($(parent).width() - $(this).outerWidth()) / 2) + $(parent).scrollLeft()) + "px");}
        return this;
    };

    // alert centering
    $('.flash.alert-box.centered').center({'mode': "horizontally"});

    // navs


    // form fixes
    $(document).ready(function() {

        $("form.zf5-form .w2p_list a").each(function() {
            // the plus and minus buttons are generated by web2py.js
            $(this).addClass('button tiny secondary');
        });

        $("form.zf5-form input[name='password_two']").each(function() {
            // auth addition after form creation
            var $this = $(this);
            var hasError = false;
            var error = $this.next('span.error');
            var groupClass = 'row';
            var mode;
            var labelClass;
            if ($this.parent().hasClass('form-horizontal')) {
                mode = 'horizontal';
                labelClass = 'right';
            };
            if ($this.parent().hasClass('form-inline')) {
                mode = 'inline';
                labelClass = 'inline right';
            };
            if (error.length > 0) {
                var hasError = true;
                groupClass = 'row error';
                var text = error[0].nextSibling.nodeValue;
                    if (text) {
                        error[0].parentNode.removeChild(error[0].nextSibling);
                    };
            } else {
                var text = $this[0].nextSibling.nodeValue;
                if (text) {
                    $this.attr("placeholder", text);
                    $this[0].parentNode.removeChild($this[0].nextSibling);
                };
            };
            if (mode == 'horizontal' || mode == 'inline') {
                var fh_label_class = $this.parent().attr('data-form-label-class');
                var sClasses = fh_label_class.split('-');
                var fh_control_class = sClasses[0]+'-'+(12-sClasses[1]);
                $this.prev('label').andSelf().wrapAll("<div class='"+groupClass+"' id='auth_user_verify_password__row'></div>");
                $this.prev('label').addClass(labelClass).wrap("<div class='"+fh_label_class+" columns'></div>");
                $this.wrap("<div class='"+fh_control_class+" columns'></div>");
            } else {
                $this.prev('label').andSelf().wrapAll("<div class='"+groupClass+"' id='auth_user_verify_password__row'></div>");
            };
            if (hasError) {
                $this.parent().append(error);
            };
        });

        $('form.zf5-form #auth_user_remember').each(function() {
            // auth addition after form creation
            var $input = $(this);
            var $label = $input.next('label').attr('data-w2p_form_element', 'rc');
            var $iParent = $input.parent();
            $input.removeClass('checkbox');
            $iParent.prev('label').remove();
            var newGroup = $iParent.closest('div').addClass('row').html('').append($input,$label);
            if (newGroup.parent().hasClass('form-horizontal') || newGroup.parent().hasClass('form-inline')) {
                var sClasses = newGroup.parent().attr('data-form-label-class').split('-');
                var fh_offest_class = sClasses[0]+'-offset-'+sClasses[1];
                var fh_control_class = sClasses[0]+'-'+(12-sClasses[1]);
                newGroup.wrapInner('<div class="'+fh_offest_class+' '+fh_control_class+' columns"></div>');
            };
        });

    });

    // form errors
    $('form.zf5-form .error_wrapper').each(function() {
        var $this = $(this);
        var rcContainer = $this.parents('.rc_container');
        var errMessage = $this.html().replace(/div/g,'span');
        if (rcContainer.length > 0) {
            $(errMessage).appendTo(rcContainer);
            $this.remove();
        } else {
            $this.replaceWith(errMessage);
        }
    });
    $('form.zf5-form').find('span.error').attr("style", "").closest("form div.row").addClass('error');

    // uploadwidget
    $('#file-reset-btn').click(function() {
        var el = $('div.w2p-uploaded-file')[0];
        var whatReset = jQuery.data(el, "reset");
        if (whatReset == "changed") {
            $('.w2p-uploaded-file input[type="file"]')
                .replaceWith(
                    $('.w2p-uploaded-file input[type="file"]')
                        .clone());
            $('.w2p-file-preview, .w2p-uploaded-file input[type="file"], #edit-btn-dd, #file-reset-btn').toggle();
        }else{
            $('.w2p-file-preview, #no-file, #edit-btn-dd, #file-reset-btn').toggle();
            $('div.w2p-uploaded-file').children('input[type=checkbox]').trigger('click');
        }
        jQuery.removeData(el, "reset");
    });
    $('#change-file-option').click(function(e) {
        e.preventDefault();
        $('.w2p-file-preview, .w2p-uploaded-file input[type="file"], #edit-btn-dd, #file-reset-btn').toggle();
        jQuery.data($('div.w2p-uploaded-file')[0], "reset", "changed");
    });
    $('#delete-file-option').click(function(e) {
        e.preventDefault();
        var wimg = $('#image-thumb').outerWidth(),
            himg = $('#image-thumb').outerHeight();
        $('#no-file')
            .width(wimg)
            .height(himg)
            .css({'line-height':himg+'px'});
        $('.w2p-file-preview, #no-file, #edit-btn-dd, #file-reset-btn').toggle();
        $('div.w2p-uploaded-file').children('input[type=checkbox]').trigger('click');
        jQuery.data($('div.w2p-uploaded-file')[0], "reset", "deleted");
    });

    // on page load
    $('ul.clearing-thumbs').attr("data-clearing", "");
    $('ul.f-dropdown').attr("data-dropdown-content", "");
    $('ul.w2p-orbit').attr("data-orbit", "");
    $.web2py.manage_errors = function (target) {
      $('span.error', target).hide().slideDown('slow');
    };

    // resize and orientation change events
    $(window).on('orientationchange resize', function(event) {
        $('.flash.alert').center({'mode':"horizontally"});
    });

}(jQuery));
